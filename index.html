<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeX AI - Your Creative Partner</title>
    <style>
        /* CSS Reset and Global Styles */
        :root {
            --bg-color: #131314;
            --surface-color: #1e1f20;
            --primary-text-color: #e3e3e3;
            --secondary-text-color: #bdc1c6;
            --accent-color-start: #89b3f8;
            --accent-color-end: #bf89f8;
            --border-color: #3c4043;
            --input-bg-color: #2a2b2e;
            --hover-bg-color: #3c4043;
            --card-bg-color: #282a2d;
            --font-family: 'Noto Sans Arabic', 'Google Sans', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
        }
        
        body {
            height: 100%;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            font-family: var(--font-family);
            line-height: 1.6;
            /* IMPORTANT FIX: Prevent body scrolling on mobile */
            overflow: hidden; 
        }

        /* Login Modal Styles */
        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease;
            padding: 15px;
        }

        .login-container {
            background-color: var(--surface-color);
            padding: 30px 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
            text-align: center;
            animation: fadeIn 0.7s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .login-container h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--accent-color-start), var(--accent-color-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-container p {
            color: var(--secondary-text-color);
            margin-bottom: 25px;
            font-size: 0.95rem;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-text-color);
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg-color);
            color: var(--primary-text-color);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-color-start);
            box-shadow: 0 0 0 3px rgba(137, 179, 248, 0.3);
        }

        .hobbies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
        }

        .hobby-card {
            background-color: var(--input-bg-color);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 8px;
            font-size: 0.9rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hobby-card.selected {
            background-color: rgba(137, 179, 248, 0.2);
            border-color: var(--accent-color-start);
            transform: translateY(-5px);
        }

        .hobby-card svg {
            width: 28px;
            height: 28px;
            margin-bottom: 8px;
            fill: var(--secondary-text-color);
            transition: fill 0.3s;
        }
        
        .hobby-card.selected svg {
            fill: var(--accent-color-start);
        }

        #login-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(90deg, var(--accent-color-start), var(--accent-color-end));
            color: #000;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
        }

        #login-button:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(137, 179, 248, 0.3);
        }

        /* Main App Structure */
        #app-container {
            display: none;
            height: 100vh; /* Full viewport height */
            width: 100vw; /* Full viewport width */
            display: flex;
        }

        /* Sidebar */
        #sidebar {
            width: 250px;
            background-color: var(--surface-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
            transition: transform 0.3s ease;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .sidebar-header h2 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, var(--accent-color-start), var(--accent-color-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--input-bg-color);
            color: var(--primary-text-color);
            border: none;
            padding: 12px 15px;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            text-align: right;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        
        .new-chat-btn:hover {
            background-color: var(--hover-bg-color);
        }

        .history { flex-grow: 1; overflow-y: auto; }
        .history h3 { color: var(--secondary-text-color); font-size: 0.9rem; text-transform: uppercase; margin-bottom: 10px; }
        .history ul { list-style: none; }
        .history li { padding: 10px 15px; border-radius: 20px; margin-bottom: 5px; cursor: pointer; transition: background-color 0.3s; }
        .history li:hover { background-color: var(--hover-bg-color; }

        .sidebar-footer { padding-top: 20px; border-top: 1px solid var(--border-color); }
        #logout-button { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px; border-radius: 8px; font-size: 1rem; }
        #logout-button:hover { background-color: var(--hover-bg-color); color: var(--primary-text-color); }

        /* Chat Area */
        #chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full height for the chat area */
            overflow: hidden; /* Prevent this container from scrolling */
        }
        
        .chat-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        
        .chat-header #user-greeting { font-size: 1.2rem; font-weight: 500; }
        .menu-toggle { display: none; cursor: pointer; background: none; border: none; }

        /* --- IMPORTANT FIX FOR SCROLLING --- */
        #chat-container {
            flex-grow: 1;
            overflow-y: auto; /* This makes ONLY the chat container scrollable */
            padding: 0 15px;
        }

        .chat-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 0;
        }
        
        .welcome-message { text-align: center; padding: 50px 20px; }
        .welcome-message h1 { font-size: 3rem; font-weight: 700; background: linear-gradient(90deg, var(--accent-color-start), var(--accent-color-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; }
        .welcome-message p { font-size: 1.2rem; color: var(--secondary-text-color); }

        .message { display: flex; margin-bottom: 20px; animation: messageFadeIn 0.5s ease; max-width: 95%; }
        @keyframes messageFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message .avatar { width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-left: 12px; flex-shrink: 0; }
        .message .avatar.user-avatar { background: linear-gradient(135deg, var(--accent-color-start), var(--accent-color-end)); color: var(--bg-color); font-weight: bold; }
        .message .text-content { padding: 12px 18px; background-color: var(--surface-color); border-radius: 18px; max-width: calc(100% - 47px); word-wrap: break-word; }
        .message.user { justify-content: flex-start; flex-direction: row-reverse; align-self: flex-end; }
        .message.user .avatar { margin-right: 12px; margin-left: 0; }
        .message.user .text-content { background-color: var(--card-bg-color); }
        .message.ai { align-self: flex-start; }

        .typing-indicator { display: flex; align-items: center; gap: 5px; }
        .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background-color: var(--secondary-text-color); animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* Input Area */
        #input-area {
            padding: 15px;
            flex-shrink: 0; /* Prevent input area from shrinking */
        }

        .input-wrapper { max-width: 800px; margin: 0 auto; position: relative; }
        #chat-input { width: 100%; background-color: var(--input-bg-color); border: 1px solid var(--border-color); border-radius: 28px; padding: 15px 60px 15px 20px; color: var(--primary-text-color); font-size: 1rem; font-family: inherit; resize: none; line-height: 1.5; max-height: 150px; overflow-y: auto; }
        #chat-input:focus { outline: none; border-color: var(--accent-color-start); }
        #send-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: var(--accent-color-start); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.3s; }
        #send-btn:hover { background-color: #a2c6f9; }

        /* --- RESPONSIVE DESIGN FIXES --- */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            #sidebar { position: fixed; top: 0; right: 0; height: 100%; z-index: 200; transform: translateX(100%); box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
            #sidebar.open { transform: translateX(0); }
            #chat-area { width: 100%; }
            .menu-toggle { display: block; z-index: 201; }
            .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 199; display: none; }
            .overlay.active { display: block; }
            .welcome-message h1 { font-size: 2.2rem; }
            .welcome-message p { font-size: 1.1rem; }
            #input-area { padding: 10px; }
            #chat-input { padding: 12px 55px 12px 15px; }
            #send-btn { width: 36px; height: 36px; }
            .message .avatar { width: 30px; height: 30px; margin-left: 10px; }
            .message.user .avatar { margin-right: 10px; margin-left: 0; }
        }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-container">
            <h1>مرحباً بك في CodeX AI</h1>
            <p>شريكك الإبداعي الجديد. لنبدأ بتخصيص تجربتك.</p>
            <form id="login-form">
                <div class="input-group">
                    <label for="username">ما هو اسمك؟</label>
                    <input type="text" id="username" placeholder="ادخل اسمك هنا" required>
                </div>
                <div class="input-group">
                    <label>ما هي اهتماماتك الرئيسية؟ (اختر 3 على الأقل)</label>
                    <div class="hobbies-grid">
                        </div>
                </div>
                <button type="submit" id="login-button">لنبدأ الرحلة</button>
            </form>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>

    <div id="app-container">
        <main id="chat-area">
            <header class="chat-header">
                <div id="user-greeting"></div>
                <button class="menu-toggle" id="menu-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#e3e3e3"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                </button>
            </header>
            <div id="chat-container">
                <div class="chat-content" id="chat-content">
                    <div class="welcome-message" id="welcome-message">
                         <h1>أهلاً بك!</h1>
                         <p>كيف يمكنني مساعدتك اليوم؟</p>
                    </div>
                </div>
            </div>
            <div id="input-area">
                <div class="input-wrapper">
                    <textarea id="chat-input" placeholder="اسأل CodeX AI أي شيء..." rows="1"></textarea>
                    <button id="send-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                    </button>
                </div>
            </div>
        </main>
        
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2>CodeX AI</h2>
            </div>
            <button class="new-chat-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" fill="#e3e3e3"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                <span>محادثة جديدة</span>
            </button>
            <div class="history">
                <h3>المحادثات السابقة</h3>
                <ul>
                    <li style="color: var(--secondary-text-color); font-size: 0.9rem; text-align: center; cursor: default;">لا توجد محادثات بعد</li>
                </ul>
            </div>
            <div class="sidebar-footer">
                <button id="logout-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" fill="#bdc1c6"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                    <span>تسجيل الخروج</span>
                </button>
            </div>
        </aside>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const loginModal = document.getElementById('login-modal');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const hobbiesGrid = document.querySelector('.hobbies-grid');
    const logoutButton = document.getElementById('logout-button');
    const userGreeting = document.getElementById('user-greeting');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatContent = document.getElementById('chat-content');
    const welcomeMessage = document.getElementById('welcome-message');
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const overlay = document.getElementById('overlay');
    
    const hobbies = [
        { id: 'programming', name: 'البرمجة', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>' },
        { id: 'reading', name: 'القراءة', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.59,11.59l-5.29-5.29a2,2,0,0,0-2.83,0L3,16.71V21H7.29l10.42-10.42a2,2,0,0,0,0-2.83ZM6.21,19H5V17.79l8.42-8.42,1.21,1.21ZM21,7.29l-1.42,1.42-1.21-1.21L19.79,6a1,1,0,0,1,1.41,0,1,1,0,0,1,0,1.41Z"/></svg>' },
        { id: 'gaming', name: 'الألعاب', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.58 16.09l-1.09-7.66C20.21 6.46 18.52 5 16.53 5H7.47C5.48 5 3.79 6.46 3.51 8.43l-1.09 7.66C2.2 17.63 3.39 19 4.94 19h0c.68 0 1.32-.27 1.76-.75L9 15.5v-2.5h6v2.5l2.29 2.75c.44.48 1.08.75 1.76.75h0c1.55 0 2.74-1.37 2.53-2.91zM11 11H9v2h2v-2zm4 0h-2v2h2v-2z"/></svg>' },
        { id: 'travel', name: 'السفر', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>' },
        { id: 'sports', name: 'الرياضة', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM5 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8c-1.6 0-3-1.4-3-3s1.4-3 3-3 3 1.4 3 3-1.4 3-3 3zm11.5-2.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.8-3.2c-1-.4-2.2-.6-3.4-.6-1.5 0-2.8.3-4.1.8.3-2.4 2.2-4.3 4.6-4.6.4-1.2 1.5-2.2 2.9-2.2 1.6 0 3 1.3 3 3 0 .5-.1.9-.3 1.3.8.3 1.5.8 2 1.4-.5.2-1 .3-1.3.3-1.1 0-2.1-.5-2.8-1.1z"/></svg>' },
        { id: 'music', name: 'الموسيقى', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>' },
    ];
    
    let user = null;

    // --- IMPROVED KNOWLEDGE BASE ---
    const knowledgeBase = {
        greetings: {
            keywords: ["مرحبا", "أهلا", "السلام عليكم", "صباح الخير", "مساء الخير", "هاي", "hello", "hi", "اهلا"],
            responses: [
                "أهلاً بك! كيف يمكنني مساعدتك اليوم؟",
                "وعليكم السلام! يسعدني خدمتك.",
                "مرحباً! أنا هنا لمساعدتك. بماذا تفكر؟",
            ]
        },
        farewell: {
            keywords: ["وداعا", "باي", "إلى اللقاء", "مع السلامة", "goodbye", "bye"],
            responses: [ "إلى اللقاء! أتمنى لك وقتاً ممتعاً.", "مع السلامة! أنا موجود دائماً إذا احتجتني." ]
        },
        about_self: {
            keywords: ["من أنت", "ما هو اسمك", "ماذا تفعل", "قدراتك", "عرفني بنفسك", "who are you"],
            responses: [ "أنا CodeX AI، نموذج لغوي متقدم تم تطويري لمساعدتك في مجموعة واسعة من المهام.", "اسمي CodeX AI. أنا مساعد ذكاء اصطناعي مصمم لأكون شريكك في الإبداع والمعرفة." ]
        },
        creator: {
            keywords: ["من صنعك", "من طورك", "من برمجك", "who made you"],
            responses: [ "تم تصميمي وبرمجتي بواسطة مطور موهوب يستخدم أحدث تقنيات الواجهات الأمامية.", "أنا نتاج إبداع مطور شغوف بالذكاء الاصطناعي وتجربة المستخدم." ]
        },
        thanks: {
            keywords: ["شكرا", "مشكور", "thank you", "thanks"],
            responses: [ "على الرحب والسعة!", "العفو! لا تتردد في طرح المزيد من الأسئلة.", "لا شكر على واجب." ]
        },
        how_are_you: {
            keywords: ["كيف حالك", "عامل ايه", "اخبارك", "how are you"],
            responses: [ "أنا بخير، مجرد أكواد تعمل بانسجام. شكراً لسؤالك! كيف حالك أنت؟", "أنا في أفضل حال وجاهز للمساعدة. كيف يمكنني خدمتك؟" ]
        },
        what_is_js: { keywords: ["javascript", "جافاسكريبت", "js"], responses: ["جافاسكريبت هي لغة برمجة عالية المستوى، تُستخدم بشكل أساسي لجعل صفحات الويب تفاعلية."] },
        what_is_python: { keywords: ["python", "بايثون"], responses: ["بايثون هي لغة برمجة متعددة الأغراض تشتهر ببساطتها. تستخدم على نطاق واسع في تطوير الويب، تحليل البيانات، والذكاء الاصطناعي."] },
        capital_of_egypt: { keywords: ["عاصمة مصر"], responses: ["عاصمة جمهورية مصر العربية هي القاهرة."] },
        capital_of_france: { keywords: ["عاصمة فرنسا"], responses: ["عاصمة فرنسا هي باريس."] },
        story_prompt: { keywords: ["اكتب قصة", "احكي لي قصة"], responses: ["بالطبع! كان يا مكان في غابة مسحورة، يعيش ثعلب صغير فضولي يدعى 'فطن'. في يوم من الأيام، وجد خريطة قديمة تلمع تحت جذر شجرة عملاقة..."] },
        motivation_prompt: { keywords: ["تحفيز", "كلام ايجابي"], responses: ["تذكر دائماً أن كل خطوة صغيرة تقربك من هدفك الكبير. لا تقلل من شأن جهودك اليومية، فهي التي تبني المستقبل."] },
        hobby_intro: { keywords: ["اهتماماتي", "هواياتي"], responses: ["بناءً على ما أخبرتني به، أعرف أنك مهتم بـ {hobbies}. هذا رائع! هل لديك سؤال محدد حول أي من هذه الهوايات؟"] },
        fallback: {
            keywords: [],
            responses: [
                "هذا سؤال مثير للاهتمام. ما زلت أتعلم وقد لا أملك إجابة دقيقة حاليًا. هل يمكنك إعادة صياغة السؤال؟",
                "لم أفهم سؤالك تمامًا. هل يمكنك توضيحه أكثر؟",
                "معلوماتي حول هذا الموضوع محدودة في الوقت الحالي. هل هناك شيء آخر يمكنني مساعدتك به؟"
            ]
        }
    };
    
    function init() {
        populateHobbies();
        const storedUser = localStorage.getItem('codeXUser');
        if (storedUser) {
            user = JSON.parse(storedUser);
            showApp();
        } else {
            showLogin();
        }
        setupEventListeners();
    }
    
    function populateHobbies() {
        hobbies.forEach(hobby => {
            const card = document.createElement('div');
            card.className = 'hobby-card';
            card.dataset.id = hobby.id;
            card.innerHTML = `${hobby.icon}<span>${hobby.name}</span>`;
            card.addEventListener('click', () => card.classList.toggle('selected'));
            hobbiesGrid.appendChild(card);
        });
    }

    function showLogin() {
        loginModal.style.display = 'flex';
        appContainer.style.display = 'none';
        setTimeout(() => loginModal.style.opacity = 1, 10);
    }
    
    function showApp() {
        userGreeting.textContent = `مرحباً، ${user.name}!`;
        loginModal.style.opacity = 0;
        setTimeout(() => {
            loginModal.style.display = 'none';
            appContainer.style.display = 'flex';
        }, 500);
    }
    
    function handleLogin(e) {
        e.preventDefault();
        const username = usernameInput.value.trim();
        const selectedHobbies = Array.from(document.querySelectorAll('.hobby-card.selected')).map(card => hobbies.find(h => h.id === card.dataset.id).name);
        if (!username || selectedHobbies.length < 3) {
            alert('الرجاء إدخال اسمك واختيار 3 اهتمامات على الأقل.');
            return;
        }
        user = { name: username, hobbies: selectedHobbies };
        localStorage.setItem('codeXUser', JSON.stringify(user));
        showApp();
    }
    
    function handleLogout() {
        localStorage.removeItem('codeXUser');
        user = null;
        chatContent.innerHTML = ''; 
        chatContent.appendChild(welcomeMessage);
        showLogin();
    }
    
    function appendMessage(text, sender) {
        const welcomeMsg = document.getElementById('welcome-message');
        if (welcomeMsg) welcomeMsg.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        let avatarContent = sender === 'user' ? 
            `<div class="avatar user-avatar">${user.name.charAt(0)}</div>` :
            `<div class="avatar ai-avatar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" fill="#bf89f8"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM17.5 10.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm-11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm5.5 4c-1.33 0-2.52.4-3.55 1.14.33.64.77 1.21 1.3 1.67C10.15 17.82 11.05 18 12 18s1.85-.18 2.75-.49c.53-.46.97-1.03 1.3-1.67C14.52 14.9 13.33 14.5 12 14.5z"/></svg></div>`;
        
        const textDiv = document.createElement('div');
        textDiv.className = 'text-content';
        let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        textDiv.innerHTML = formattedText;
        
        messageDiv.innerHTML = avatarContent;
        messageDiv.appendChild(textDiv);
        
        chatContent.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showTypingIndicator() {
        const indicatorDiv = document.createElement('div');
        indicatorDiv.className = 'message ai typing-indicator-wrapper';
        indicatorDiv.innerHTML = `<div class="avatar ai-avatar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" fill="#bf89f8"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z.../></svg></div><div class="text-content typing-indicator"><span></span><span></span><span></span></div>`;
        chatContent.appendChild(indicatorDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.querySelector('.typing-indicator-wrapper');
        if (indicator) indicator.remove();
    }

    /**
     * --- IMPROVED AI LOGIC ---
     * @param {string} query - The user's input.
     * @returns {string} The AI's response.
     */
    function getAIResponse(query) {
        const lowerQuery = query.toLowerCase().trim();

        for (const key in knowledgeBase) {
            if (key !== 'fallback') {
                for (const keyword of knowledgeBase[key].keywords) {
                    // NEW LOGIC: Check if the query *includes* the keyword. More flexible.
                    if (lowerQuery.includes(keyword)) {
                        const responses = knowledgeBase[key].responses;
                        let response = responses[Math.floor(Math.random() * responses.length)];
                        if (response.includes('{hobbies}')) {
                            response = response.replace('{hobbies}', user.hobbies.join(', '));
                        }
                        return response;
                    }
                }
            }
        }
        
        const fallbackResponses = knowledgeBase.fallback.responses;
        return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
    }

    function handleSendMessage() {
        const userInput = chatInput.value.trim();
        if (!userInput) return;

        appendMessage(userInput, 'user');
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        showTypingIndicator();
        
        setTimeout(() => {
            removeTypingIndicator();
            const aiResponse = getAIResponse(userInput);
            appendMessage(aiResponse, 'ai');
        }, 1000 + Math.random() * 500);
    }
    
    function setupEventListeners() {
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        sendBtn.addEventListener('click', handleSendMessage);
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = `${chatInput.scrollHeight}px`;
        });

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });
        
        overlay.addEventListener('click', () => {
             sidebar.classList.remove('open');
             overlay.classList.remove('active');
        });
    }

    init();
});
</script>

</body>
</html>
